
{#if field.data != null}
<h3>{field.data.items[0].month} {field.data.items[0].year}</h3>

<table class="table" ref:table>
	<thead>
		<tr>
			<th></th>
			{#if days != null && days.length > 1}
				{#each days as day}
					<th class="day-number">{day.day}</th>
				{/each}
			{/if}
		</tr>
		<tr>
			<th></th>
			{#if days != null && days.length > 1}
				{#each days as day}
					<th class="day">{getDayName(new Date(field.data.items[0].year,getMonth(field.data.items[0].month),day.day).getDay())}</th>
				{/each}
			{/if}
		</tr>
	</thead>

	<tbody>
		{#if users != null && users.length > 0}
			{#each users as user}
			<tr>
				<td>{user.name}</td>
				{#if days != null && days.length > 0}
					{#each days as day}
						{#if user.schedules != null && user.schedules.length > 0}
							{#if getUserSchedule(day.schedules, user).length > 1}
								<td class="tag" data-tooltip="{getUserActivities(day.schedules, user)}">
									{getUserSchedule(day.schedules, user)[0].tag}
								</td>
							{:elseif getUserSchedule(day.schedules, user) != ''}
								<td data-tooltip="{getUserActivities(day.schedules, user)}">
									{getUserSchedule(day.schedules, user)[0].tag}
								</td>
							{:else}
								<td>{getUserSchedule(day.schedules, user)}</td>
							{/if}
						{:else}
						<td></td>
						{/if}
					{/each}
				{/if}
			</tr>
			{/each}
		{/if}
	</tbody>
</table>
{/if}

<script>
	export default {
		onstate() {
			const { data } = this.get().field;

			if (data == null) {
				return;
			}

			const users = data.items;

			const days = [];
			for (let day = 1; day <= 31; day++) {
				const schedules = [];
				for (const user of users) {
					const task = this.getTasksForTheDay(day, user.schedules);
					schedules.push({ user, task });
				}
				days.push({
					day,
					schedules
				});
			}

			this.set({
				days
			});
		},
		methods: {
			getTasksForTheDay(dayNumber, allActivities) {
				return allActivities.filter(t => t.day === dayNumber);
			}
		},
		computed: {
			users: field => {
				if (field.data != null) {
					return field.data.items;
				}

				return [];
			}
		},
		helpers: {
			getUserSchedule(schedules, user) {
				const schedule = schedules.filter(a => a.user === user)[0];
				if (schedule != null) {
					return schedule.task;
				}

				return [];
			},
			getUserActivities(schedules, user) {
				const events = [];
				const schedule = schedules.filter(a => a.user === user)[0];
				if (schedule != null) {
					for (const task of schedule.task) {
						events.push(task.event);
					}
					return events;
				}

				return [];
			},
			getMonth(month) {
				return new Date(Date.parse(`${month} 1, 2012`)).getMonth();
			},
			getDayName(day) {
				const days = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
				return days[day];
			}
		},
		components: {}
	};
</script>

<style>
	.table {
		margin-bottom: 40px;
		font-size: 12px;
	}

	th,
	td {
		font-size: 13px;
	}

	table > tbody > tr > td {
		font-size: 8px;
	}

	.tableHeader {
		text-align: center;
		font-weight: bold;
	}

	th.day {
		font-size: 9px;
	}

	.day-number {
		font-size: 11px;
	}

	.tag {
		background-image: linear-gradient(225deg, red, red 8px, transparent 2px, transparent);
	}
</style>