{{#if field.data != null && pages.length > 0}}
<div>
	<select class="pagination-size input-sm" bind:value="field.pageSize" on:change="changePageSize()">
		<option value="10">10</option>
		<option value="20">20</option>
		<option value="50">50</option>
		<option value="100">100</option>
	</select>
<ul class="pagination pagination-sm">
	{{#each pages as page}}
	{{#if parent.get('useUrl')}}
	<li class="page-item"><a href="{{app.makeUrl(form.metadata.id, page.params)}}" class="{{page.cssClass}} page-link">{{page.text}}</a></li>
	{{else}}
	<li class="page-item"><button on:click="goToPage(page)" class="{{page.cssClass}} page-link">{{page.text}}</button></li>
	{{/if}} {{/each}}
</ul>
</div>
<div class="paginator-summary">showing {{field.data.items.results.length}} out of {{field.data.items.totalCount}} items</div>
{{/if}}
{{#if field.data != null}}
<div class="list-group notification-space">
{{#each notifications as notification}}
<div class="list-group-item list-group-item-action flex-column align-items-start">
	<small class="notification-date">{{dateFormat(notification.createdOn)}}</small>
	<h6 class="mb-1">{{{parseSummary(notification, app)}}}</h6>
	<p class="mb-1 description" data-tooltip="{{notification.description}}">{{notification.description}}</p>
	{{#if notification.actions != null}}
		<ActionList field="{{getField(notification)}}" app="{{app}}" form="{{form}}" parent="{{parent}}" showLabel="false" />
	{{/if}}
</div>
{{/each}}
</div>
{{/if}}

<script>
	 import { OutputFieldValue } from "core-framework";
	 import FormOutput from "../Output";
	import ActionList from "./ActionList";

		function humanize(e) {
			return e.replace(/\.[^/.]+$/, "")
				.split(/(?=[A-Z])/)
				.join(" ");
		}

	export default {
		oncreate() {
			var field = this.get("field");
			var form = this.get("form");
			if (field.data == null) {
				return;
			}
			var paginatorInput = form.inputs.find(t => t.metadata.id == field.metadata.customProperties.paginator);
			field.pageSize = paginatorInput.value.pageSize;
			this.set({
				pageSize: field.pageSize
			});
		},
		methods: {
				goToPage(page) {
					var parent = this.get("parent");
					var form = parent.get("form");
					var field = this.get("field");

					form.setInputFields(page.params);
					parent.submit(null, false);
				},
				changePageSize: function () {
					var parent = this.get("parent");
					var form = parent.get("form");
					var field = this.get("field");

					var paginatorInput = form.inputs.find(t => t.metadata.id == field.metadata.customProperties.paginator);
					paginatorInput.value.pageSize = field.pageSize;
					paginatorInput.value.pageIndex = 1;
					var params = {};
					for (let i of form.inputs) {
						params[i.metadata.id] = i.value;
					}
					form.setInputFields(params);
					parent.submit(null, false);
			}
			},
		computed: {
				notifications: (field) => {
					return field.data.items.results;
				},
				pages: (field, form, parent) => {
					var paginatorInput = form.inputs.find(t => t.metadata.id == field.metadata.customProperties.paginator);

					var pageCount = Math.ceil(field.data.items.totalCount / paginatorInput.value.pageSize);

					var params = {};
					for (let i of form.inputs) {
						params[i.metadata.id] = i.value;
					}

					if(pageCount > 0){
					var pages =[];

					if (pageCount < paginatorInput.value.pageIndex) {
							paginatorInput.value.pageIndex = 1;
							form.setInputFields(params);
							parent.submit(null, false);
						}
						
					for (let p = 1; p <= pageCount; ++p) {
						let pageParams = Object.assign({}, params);
						pageParams[paginatorInput.metadata.id] = Object.assign({}, pageParams[paginatorInput.metadata.id]);
						pageParams[paginatorInput.metadata.id].pageIndex = p;

						pages.push({
							text: p,
							params: pageParams,
							cssClass: paginatorInput.value.pageIndex == p ? "current" : ""
						});
					}

					let firstParams = Object.assign({}, params);
						firstParams[paginatorInput.metadata.id] = Object.assign({}, firstParams[paginatorInput.metadata.id]);
						firstParams[paginatorInput.metadata.id].pageIndex = 1;

						var first = {
							text: "First",
							params: firstParams,
							cssClass: paginatorInput.value.pageIndex == 1 ? "btn disabled" : ""
						};
						let prevParams = Object.assign({}, params);
						prevParams[paginatorInput.metadata.id] = Object.assign({}, prevParams[paginatorInput.metadata.id]);
						prevParams[paginatorInput.metadata.id].pageIndex = paginatorInput.value.pageIndex - 1;

						var previous = {
							text: "Previous",
							params: prevParams,
							cssClass: paginatorInput.value.pageIndex == 1 ? "btn disabled" : ""
						};

						let nextParams = Object.assign({}, params);
						nextParams[paginatorInput.metadata.id] = Object.assign({}, nextParams[paginatorInput.metadata.id]);
						nextParams[paginatorInput.metadata.id].pageIndex = paginatorInput.value.pageIndex + 1;

						var next = {
							text: "Next",
							params: nextParams,
							cssClass: paginatorInput.value.pageIndex == pageCount ? "btn disabled" : ""
						};

						let lastParams = Object.assign({}, params);
						lastParams[paginatorInput.metadata.id] = Object.assign({}, lastParams[paginatorInput.metadata.id]);
						lastParams[paginatorInput.metadata.id].pageIndex = pageCount;

						var last = {
							text: "Last",
							params: lastParams,
							cssClass: paginatorInput.value.pageIndex == pageCount ? "btn disabled" : ""
						};

						var from = paginatorInput.value.pageIndex;
						var to = paginatorInput.value.pageIndex;

						if (from < 5) {
							from = 0; to = 10;
						} else if (from > pageCount - 5 && pageCount > 10) {
							to = pageCount; from = pageCount - 10;
						} else {
							from -= 5;
							to += 5;
						}

						var innerPages = pages.slice(from, to);
						innerPages.unshift(previous);
						innerPages.unshift(first);
						innerPages.push(next);
						innerPages.push(last);
						return innerPages;
					}
					return [];
				}
				},
			helpers: {
					dateFormat(date) {
						var d = new Date(date),
							month = '' + (d.getMonth() + 1),
							day = '' + d.getDate(),
							year = d.getFullYear();

						if (month.length < 2) month = '0' + month;
						if (day.length < 2) day = '0' + day;

						return [year, month, day].join('-');
					},
					
					getField: function (node) {
						var result = {
							data: node.actions
						};
						return result;
					},
					parseSummary(notification, app) {
						var contextTypeParts = notification.contextType.split(".");
						var url = app.makeUrl(notification.link.form, notification.link.inputFieldValues);
						
						var entityName = humanize(contextTypeParts[contextTypeParts.length - 1]) + " #" + notification.contextId;
						return notification.summary.replace(entityName, `<a href='${url}'>${entityName}</a>`);
					}
			},
		components: {
			FormOutput,
			ActionList
		}
	}

</script>
<style>
.notification-date {
	display: inline-block;
    margin-right: 10px;
}

.notification-space {
	margin-bottom: 30px;
}
.notification-space h6{
	display: inline-block;
}
.notification-space p{
	margin-left: 0;
    display: inline-block;
}
.notification-space .actionlist{
    float: right;
	background: none
}
.description {
	text-overflow: ellipsis;
    max-width: 50%;
    white-space: nowrap;
    overflow: hidden;
    display: inline-block;
	position: relative;
	top: 10px;
}
	</style>